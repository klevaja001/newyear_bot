import os
import logging
from flask import Flask, request
import telebot
from datetime import datetime
import threading
import time
import schedule

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

app = Flask(__name__)

# –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –∏ ID –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è Render
BOT_TOKEN = os.environ.get('BOT_TOKEN')
USER_ID = os.environ.get('USER_ID')

if not BOT_TOKEN or not USER_ID:
    logger.error("‚ùå BOT_TOKEN –∏–ª–∏ USER_ID –Ω–µ –∑–∞–¥–∞–Ω—ã!")
    raise ValueError("–ó–∞–¥–∞–π—Ç–µ BOT_TOKEN –∏ USER_ID –≤ Render Environment Variables")

bot = telebot.TeleBot(BOT_TOKEN)
logger.info(f"‚úÖ –ë–æ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {USER_ID}")

# 31 –Ω–æ–≤–æ–≥–æ–¥–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ
tasks = [
    "üéÑ 1 –¥–µ–∫–∞–±—Ä—è: –ù–∞—á–∞—Ç—å —É–∫—Ä–∞—à–∞—Ç—å –∫–≤–∞—Ä—Ç–∏—Ä—É –∫ –ø—Ä–∞–∑–¥–Ω–∏–∫–∞–º",
    "‚òï 2 –¥–µ–∫–∞–±—Ä—è: –ü—Ä–∏–≥–æ—Ç–æ–≤–∏—Ç—å –≥–æ—Ä—è—á–∏–π —à–æ–∫–æ–ª–∞–¥ —Å –º–∞—Ä—à–º–µ–ª–ª–æ—É –∏ —Å–ø–µ—Ü–∏—è–º–∏",
    "üéÖ 3 –¥–µ–∫–∞–±—Ä—è: –†–∞–∑—ã–≥—Ä–∞—Ç—å —Ç–∞–π–Ω–æ–≥–æ –°–∞–Ω—Ç—É",
    "üéµ 4 –¥–µ–∫–∞–±—Ä—è: –°–æ—Å—Ç–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ–¥–Ω–∏–π –ø–ª–µ–π–ª–∏—Å—Ç –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è",
    "üé¨ 5 –¥–µ–∫–∞–±—Ä—è: –£—Å—Ç—Ä–æ–∏—Ç—å –≤–µ—á–µ—Ä –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª—é–±–∏–º—ã—Ö –∑–∏–º–Ω–∏—Ö —Ñ–∏–ª—å–º–æ–≤",
    "‚õ∏Ô∏è 6 –¥–µ–∫–∞–±—Ä—è: –ü–æ–∫–∞—Ç–∞—Ç—å—Å—è –Ω–∞ –∫–æ–Ω—å–∫–∞—Ö –ø–æ–¥ –Ω–æ–≤–æ–≥–æ–¥–Ω—é—é –º—É–∑—ã–∫—É",
    "üç∑ 7 –¥–µ–∫–∞–±—Ä—è: –°–≤–∞—Ä–∏—Ç—å –∞–≤—Ç–æ—Ä—Å–∫–∏–π –≥–ª–∏–Ω—Ç–≤–µ–π–Ω –ø–æ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–º—É —Ä–µ—Ü–µ–ø—Ç—É",
    "üì∏ 8 –¥–µ–∫–∞–±—Ä—è: –°–æ–∑–¥–∞—Ç—å —Ñ–æ—Ç–æ–∫–Ω–∏–≥—É —É—Ö–æ–¥—è—â–µ–≥–æ –≥–æ–¥–∞",
    "üéÅ 9 –¥–µ–∫–∞–±—Ä—è: –°—Ö–æ–¥–∏—Ç—å –Ω–∞ —Ä–æ–∂–¥–µ—Å—Ç–≤–µ–Ω—Å–∫—É—é —è—Ä–º–∞—Ä–∫—É –∑–∞ —Å—É–≤–µ–Ω–∏—Ä–∞–º–∏",
    "üéÄ 10 –¥–µ–∫–∞–±—Ä—è: –ö—É–ø–∏—Ç—å –∏ —Å–æ–±—Ä–∞—Ç—å –≥–æ—Ç–æ–≤—ã–π –Ω–æ–≤–æ–≥–æ–¥–Ω–∏–π –≤–µ–Ω–æ–∫",
    "üç™ 11 –¥–µ–∫–∞–±—Ä—è: –ò—Å–ø–µ—á—å –≥–æ—Ç–æ–≤–æ–µ –∏–º–±–∏—Ä–Ω–æ–µ –ø–µ—á–µ–Ω—å–µ –∏–∑ –Ω–∞–±–æ—Ä–∞",
    "‚ùÑÔ∏è 12 –¥–µ–∫–∞–±—Ä—è: –°—Ö–æ–¥–∏—Ç—å –Ω–∞ –∑–∏–º–Ω—é—é –ø—Ä–æ–≥—É–ª–∫—É –≤ –ø–∞—Ä–∫",
    "üé≤ 13 –¥–µ–∫–∞–±—Ä—è: –£—Å—Ç—Ä–æ–∏—Ç—å –≤–µ—á–µ—Ä –Ω–∞—Å—Ç–æ–ª—å–Ω—ã—Ö –∏–≥—Ä –ø—Ä–∏ —Å–≤–µ—á–∞—Ö",
    "üìù 14 –¥–µ–∫–∞–±—Ä—è: –ù–∞–ø–∏—Å–∞—Ç—å —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π –∑–∞ –≥–æ–¥",
    "‚úâÔ∏è 15 –¥–µ–∫–∞–±—Ä—è: –ù–∞–ø–∏—Å–∞—Ç—å –ø–∏—Å—å–º–æ —Å–∞–º–æ–º—É —Å–µ–±–µ –≤ —Å–ª–µ–¥—É—é—â–∏–π –≥–æ–¥",
    "üß• 16 –¥–µ–∫–∞–±—Ä—è: –ö—É–ø–∏—Ç—å —É—é—Ç–Ω—ã–π –Ω–æ–≤–æ–≥–æ–¥–Ω–∏–π —Å–≤–∏—Ç–µ—Ä",
    "‚ú® 17 –¥–µ–∫–∞–±—Ä—è: –°–¥–µ–ª–∞—Ç—å –Ω–æ–≤–æ–≥–æ–¥–Ω–∏–µ —É–∫—Ä–∞—à–µ–Ω–∏—è –∏–∑ –≥–æ—Ç–æ–≤–æ–≥–æ –Ω–∞–±–æ—Ä–∞",
    "üßñ 18 –¥–µ–∫–∞–±—Ä—è: –°—Ö–æ–¥–∏—Ç—å –≤ –±–∞–Ω—é –∏–ª–∏ —Å–∞—É–Ω—É —Å –∞—Ä–æ–º–∞–º–∞—Å–ª–∞–º–∏",
    "üç£ 19 –¥–µ–∫–∞–±—Ä—è: –ó–∞–∫–∞–∑–∞—Ç—å —Å—É—à–∏ –∏ —É—Å—Ç—Ä–æ–∏—Ç—å –∫–∏–Ω–æ–≤–µ—á–µ—Ä",
    "üèîÔ∏è 20 –¥–µ–∫–∞–±—Ä—è: –ü–æ–µ—Ö–∞—Ç—å –∑–∞ –≥–æ—Ä–æ–¥ –Ω–∞ –∑–∏–º–Ω—é—é –ø—Ä–æ–≥—É–ª–∫—É",
    "üç∞ 21 –¥–µ–∫–∞–±—Ä—è: –°—Ö–æ–¥–∏—Ç—å –≤ –∫–∞—Ñ–µ –Ω–∞ –ø—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–π –¥–µ—Å–µ—Ä—Ç",
    "üé• 22 –¥–µ–∫–∞–±—Ä—è: –°—Ö–æ–¥–∏—Ç—å –≤ –∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä –Ω–∞ –ø—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–π —Ñ–∏–ª—å–º",
    "üéÄ 23 –¥–µ–∫–∞–±—Ä—è: –£–ø–∞–∫–æ–≤–∞—Ç—å –ø–æ–¥–∞—Ä–∫–∏ –≤ –∫—Ä–∞—Å–∏–≤—É—é –±—É–º–∞–≥—É",
    "‚ù§Ô∏è 24 –¥–µ–∫–∞–±—Ä—è: –°–¥–µ–ª–∞—Ç—å –±–ª–∞–≥–æ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ–µ –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏–µ",
    "üé™ 25 –¥–µ–∫–∞–±—Ä—è: –ü–æ—Å–µ—Ç–∏—Ç—å –Ω–æ–≤–æ–≥–æ–¥–Ω—é—é —è—Ä–º–∞—Ä–∫—É –≤ —Ü–µ–Ω—Ç—Ä–µ –≥–æ—Ä–æ–¥–∞",
    "üßπ 26 –¥–µ–∫–∞–±—Ä—è: –°–¥–µ–ª–∞—Ç—å –≥–µ–Ω–µ—Ä–∞–ª—å–Ω—É—é —É–±–æ—Ä–∫—É",
    "üë• 27 –¥–µ–∫–∞–±—Ä—è: –°—Ö–æ–¥–∏—Ç—å –≤ –≥–æ—Å—Ç–∏ –∫ –¥—Ä—É–∑—å—è–º —Å —É–≥–æ—â–µ–Ω–∏—è–º–∏",
    "üé≠ 28 –¥–µ–∫–∞–±—Ä—è: –°—Ö–æ–¥–∏—Ç—å –Ω–∞ –Ω–æ–≤–æ–≥–æ–¥–Ω–∏–π –∫–æ–Ω—Ü–µ—Ä—Ç –∏–ª–∏ —Å–ø–µ–∫—Ç–∞–∫–ª—å",
    "üìä 29 –¥–µ–∫–∞–±—Ä—è: –ü–æ–¥–≤–µ—Å—Ç–∏ –∏—Ç–æ–≥–∏ –≥–æ–¥–∞ –∏ —Å–æ—Å—Ç–∞–≤–∏—Ç—å –ø–ª–∞–Ω—ã –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π",
    "üïØÔ∏è 30 –¥–µ–∫–∞–±—Ä—è: –ù–∞—Å–ª–∞–¥–∏—Ç—å—Å—è —Å–ø–æ–∫–æ–π–Ω—ã–º –≤–µ—á–µ—Ä–æ–º –ø–µ—Ä–µ–¥ –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–º",
    "‚è∞ 31 –¥–µ–∫–∞–±—Ä—è: –ó–∞–≥–∞–¥–∞—Ç—å –∂–µ–ª–∞–Ω–∏–µ –ø–æ–¥ –±–æ–π –∫—É—Ä–∞–Ω—Ç–æ–≤"
]

logger.info(f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(tasks)} –∑–∞–¥–∞–Ω–∏–π")

# –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
@app.route('/')
def home():
    today = datetime.now().day
    task = tasks[today-1] if 1 <= today <= 31 else "–ù–µ –¥–µ–∫–∞–±—Ä—å"
    
    return f'''
    <h1>üéÑ –ù–æ–≤–æ–≥–æ–¥–Ω–∏–π –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç!</h1>
    <p><strong>–í—Ä–µ–º—è —Å–µ—Ä–≤–µ—Ä–∞:</strong> {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}</p>
    <p><strong>–ó–∞–¥–∞–Ω–∏–µ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è ({today} –¥–µ–∫–∞–±—Ä—è):</strong> {task}</p>
    <p><strong>–û—Ç–ø—Ä–∞–≤–∫–∞ –≤:</strong> 05:00 UTC (08:00 –ú–°–ö)</p>
    <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ‚úÖ –ê–∫—Ç–∏–≤–µ–Ω</p>
    '''

# –í–µ–±—Ö—É–∫ –¥–ª—è Telegram
@app.route('/webhook', methods=['POST'])
def webhook():
    if request.headers.get('content-type') == 'application/json':
        json_string = request.get_data().decode('utf-8')
        update = telebot.types.Update.de_json(json_string)
        bot.process_new_updates([update])
        return ''
    return 'Bad Request', 400

# –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞
@bot.message_handler(commands=['start'])
def send_welcome(message):
    bot.reply_to(message, "üéÖ –ü—Ä–∏–≤–µ—Ç! –Ø –ù–æ–≤–æ–≥–æ–¥–Ω–∏–π –±–æ—Ç! –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 8:00 —É—Ç—Ä–∞ –ø—Ä–∏—Å—ã–ª–∞—é –∑–∞–¥–∞–Ω–∏—è. –ò—Å–ø–æ–ª—å–∑—É–π /today –¥–ª—è –∑–∞–¥–∞–Ω–∏—è –Ω–∞ —Å–µ–≥–æ–¥–Ω—è.")

@bot.message_handler(commands=['today'])
def send_today_task(message):
    today = datetime.now().day
    if 1 <= today <= 31:
        task = tasks[today-1]
        bot.reply_to(message, f"üéÅ {task}")
    else:
        bot.reply_to(message, "üéÑ –°–µ–π—á–∞—Å –Ω–µ –¥–µ–∫–∞–±—Ä—å!")

@bot.message_handler(commands=['task'])
def send_specific_task(message):
    try:
        day = int(message.text.split()[1])
        if 1 <= day <= 31:
            task = tasks[day-1]
            bot.reply_to(message, f"üìÖ {task}")
        else:
            bot.reply_to(message, "‚ùå –£–∫–∞–∂–∏—Ç–µ —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 31")
    except:
        bot.reply_to(message, "‚ùå –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: /task <—á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 31>")

@bot.message_handler(commands=['help'])
def send_help(message):
    bot.reply_to(message, "üéÑ –ö–æ–º–∞–Ω–¥—ã:\n/start - –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ\n/today - –∑–∞–¥–∞–Ω–∏–µ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è\n/task <1-31> - –∑–∞–¥–∞–Ω–∏–µ –Ω–∞ –¥–µ–Ω—å\n/help - —Å–ø—Ä–∞–≤–∫–∞")

# –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞
def send_daily_task():
    today = datetime.now().day
    if 1 <= today <= 31:
        task = tasks[today-1]
        try:
            bot.send_message(USER_ID, f"üéÑ –î–æ–±—Ä–æ–µ —É—Ç—Ä–æ! {task}\n\n–•–æ—Ä–æ—à–µ–≥–æ –¥–Ω—è! üéÖ")
            logger.info(f"‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∑–∞–¥–∞–Ω–∏–µ –Ω–∞ {today} –¥–µ–∫–∞–±—Ä—è")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {e}")

# –§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞
def scheduler():
    schedule.every().day.at("05:00").do(send_daily_task)  # 8:00 –ú–°–ö
    logger.info("‚è∞ –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–ø—É—â–µ–Ω. –ë—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –≤ 05:00 UTC")
    while True:
        schedule.run_pending()
        time.sleep(60)

if __name__ == '__main__':
    # –ó–∞–ø—É—Å–∫ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
    scheduler_thread = threading.Thread(target=scheduler, daemon=True)
    scheduler_thread.start()
    
    # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Ä—Ç –æ—Ç Render
    port = int(os.environ.get('PORT', 10000))
    logger.info(f"üöÄ –ó–∞–ø—É—Å–∫ –Ω–∞ –ø–æ—Ä—Ç—É {port}")
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º Flask
    app.run(host='0.0.0.0', port=port, debug=False)
